<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interactive Art Canvas¬†‚Äî¬†Flocking Birds Demo</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <style>
    body{display:flex;flex-direction:column;align-items:center;font-family:sans-serif;margin:0;padding:0}
    #toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    #toolbar button,#toolbar select{padding:4px 8px;font-size:14px}
    canvas{border:1px solid #aaa;touch-action:none}
  </style>
</head>
<body>
  <h3>Fabric.js¬†+¬†GSAP¬†‚Äî¬†Drawing & Flocking Demo</h3>
  <div id="toolbar">
    <button id="drawBtn">Draw ‚úèÔ∏è</button>
    <button id="eraseBtn">Eraser ü©π</button>
    <button id="selectBtn">Select üî≤</button>
    <label>Color <input type="color" id="colorPicker" value="#000000"></label>
    <label>Size
      <select id="sizePicker">
        <option value="2">2px</option>
        <option value="4" selected>4px</option>
        <option value="6">6px</option>
        <option value="8">8px</option>
        <option value="12">12px</option>
      </select>
    </label>
    <button onclick="undo()">Undo ‚Ü∂</button>
    <button onclick="redo()">Redo ‚Ü∑</button>
    <button onclick="animateSelected()">Sway¬†Selected üå≥</button>
  </div>
  <canvas id="canvas" width="800" height="600"></canvas>

<script>
/******** Canvas Setup *********/
const canvas=new fabric.Canvas('canvas',{preserveObjectStacking:true});
canvas.isDrawingMode=true;
canvas.freeDrawingBrush.width=4;
let undoStack=[],redoStack=[];

function setDrawMode(){ canvas.isDrawingMode=true; canvas.selection=false; canvas.forEachObject(o=>o.selectable=false); }
function setEraseMode(){ setDrawMode(); canvas.freeDrawingBrush.color='#ffffff'; canvas.freeDrawingBrush.width=parseInt(sizePicker.value)*4; }
function setSelectMode(){ canvas.isDrawingMode=false; canvas.selection=true; canvas.forEachObject(o=>o.selectable=true); }

drawBtn.onclick=()=>{canvas.freeDrawingBrush.color=colorPicker.value;canvas.freeDrawingBrush.width=parseInt(sizePicker.value);setDrawMode();};
eraseBtn.onclick=setEraseMode;
selectBtn.onclick=setSelectMode;
colorPicker.oninput=e=>{canvas.freeDrawingBrush.color=e.target.value;};
sizePicker.onchange=e=>{canvas.freeDrawingBrush.width=parseInt(e.target.value);};

/******** Undo / Redo *********/
canvas.on('object:added',pushState);
canvas.on('object:modified',pushState);
function pushState(){ undoStack.push(JSON.stringify(canvas.toJSON())); redoStack.length=0; }
function undo(){ if(!undoStack.length) return; redoStack.push(undoStack.pop()); const state=undoStack[undoStack.length-1]; if(state) canvas.loadFromJSON(state,()=>canvas.requestRenderAll()); }
function redo(){ if(!redoStack.length) return; const state=redoStack.pop(); if(state){ undoStack.push(state); canvas.loadFromJSON(state,()=>canvas.requestRenderAll()); } }

/******** Sway Animation *********/
function animateSelected(){ const obj=canvas.getActiveObject(); if(!obj) return alert('Select object'); gsap.to(obj,{ angle:'+=4',duration:1.5,yoyo:true,repeat:-1,ease:'sine.inOut',transformOrigin:'50% 100%',onUpdate:canvas.requestRenderAll.bind(canvas)}); }

/******** Bird Flock (unchanged core) *********/
function createBird(color='#333'){
  const body=new fabric.Polygon([{x:0,y:-6},{x:8,y:0},{x:0,y:6},{x:-8,y:0}],{fill:color,originX:'center',originY:'center'});
  const wingL=new fabric.Triangle({width:14,height:6,fill:color,left:-4,angle:-20,originX:'center',originY:'center'});
  const wingR=new fabric.Triangle({width:14,height:6,fill:color,left:4,angle:200,originX:'center',originY:'center'});
  const bird=new fabric.Group([body,wingL,wingR],{selectable:false,left:Math.random()*800,top:Math.random()*600});
  canvas.add(bird);
  gsap.to([wingL,wingR],{angle:'+=40',duration:0.3,yoyo:true,repeat:-1,ease:'sine.inOut',stagger:{each:0.05},onUpdate:canvas.requestRenderAll.bind(canvas)});
  return bird;
}
const BOUNDS={w:800,h:600},BIRD_COUNT=20,MAX_SPEED=2.5,NEIGHBOR=60;
const ALIGN_W=0.05,COH_W=0.02,SEP_W=0.08;
const birds=[],vel=[];
for(let i=0;i<BIRD_COUNT;i++){ birds[i]=createBird('#222'); vel[i]={x:Math.random()*2-1,y:Math.random()*2-1}; }
function limit(v){const m=Math.hypot(v.x,v.y);if(m>MAX_SPEED){v.x=v.x/m*MAX_SPEED;v.y=v.y/m*MAX_SPEED;}}
function flock(){
  for(let i=0;i<BIRD_COUNT;i++){
    let ax=0,ay=0,cx=0,cy=0,sx=0,sy=0,cnt=0;
    for(let j=0;j<BIRD_COUNT;j++) if(i!==j){const dx=birds[j].left-birds[i].left,dy=birds[j].top-birds[i].top,d=Math.hypot(dx,dy);if(d<NEIGHBOR){ax+=vel[j].x;ay+=vel[j].y;cx+=birds[j].left;cy+=birds[j].top;sx-=dx/d;sy-=dy/d;cnt++;}}
    if(cnt){ax/=cnt;ay/=cnt;cx=cx/cnt-birds[i].left;cy=cy/cnt-birds[i].top;}
    vel[i].x+=ax*ALIGN_W+cx*COH_W+sx*SEP_W;vel[i].y+=ay*ALIGN_W+cy*COH_W+sy*SEP_W;limit(vel[i]);
    birds[i].left+=vel[i].x;birds[i].top+=vel[i].y;
    if(birds[i].left<0||birds[i].left>BOUNDS.w){vel[i].x*=-1;birds[i].left=Math.max(0,Math.min(BOUNDS.w,birds[i].left));}
    if(birds[i].top<0||birds[i].top>BOUNDS.h){vel[i].y*=-1;birds[i].top=Math.max(0,Math.min(BOUNDS.h,birds[i].top));}
    birds[i].angle=Math.atan2(vel[i].y,vel[i].x)*180/Math.PI;
  }
  canvas.requestRenderAll();requestAnimationFrame(flock);
}
flock();
</script>
</body>
</html>
